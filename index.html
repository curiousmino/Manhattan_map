<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manhattan Neighborhood Map Tool</title>
    <style>
        /* Base styles adapted for responsiveness and modern look */
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f8f9fa; 
            padding: 16px; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            align-items: center;
        }
        h1 { 
            margin-bottom: 20px; 
            font-size: 2rem; 
            color: #1f2937; 
            font-weight: 700; 
            text-align: center;
        }
        
        /* Container and Layout Fix: Using Flex and Flexible Height */
        .container { 
            display: flex; 
            gap: 24px; 
            max-width: 1600px; 
            width: 100%;
            margin: 0 auto; 
            min-height: 0; 
            align-items: stretch; 
            /* Flexible height allows content to grow if needed */
            min-height: calc(100vh - 120px); 
        }
        
        /* Sidebar: Now flexible height */
        .sidebar { 
            flex: 1;
            min-width: 300px; 
            padding: 20px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column; 
        }

        /* Map Wrapper: Now flexible height */
        .map-wrapper { 
            flex: 2;
            min-width: 500px; 
            padding: 20px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column; 
        }

        .map-container { 
            position: relative; 
            width: 100%; 
            margin: 0 auto; 
            border-radius: 8px;
            flex-grow: 1;
            min-height: 0;
            overflow: auto;
        }

        .sidebar h2, .map-preview-title { 
            font-size: 1.25rem; 
            margin-bottom: 15px; 
            color: #1f2937; 
            font-weight: 600; 
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }
        .section { 
            margin-bottom: 20px; 
            flex-shrink: 0; 
        }

        /* Color Palette Styles */
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .palette-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .palette-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .palette-swatch.active {
            border-color: #1f2937;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #1f2937;
        }

        .custom-color-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            background: linear-gradient(135deg, #ff0000 0%, #ff7f00 17%, #ffff00 33%, #00ff00 50%, #0000ff 67%, #4b0082 83%, #9400d3 100%);
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
            font-weight: bold;
            pointer-events: none;
        }

        .custom-color-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .custom-color-btn.active {
            border: 3px solid #1f2937;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #1f2937;
        }

        /* Wrapper for custom color input */
        .custom-color-btn-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        /* Hide the actual color input but keep it functional */
        .custom-color-input {
            position: absolute;
            width: 24px;
            height: 24px;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .custom-color-input:disabled {
            cursor: not-allowed;
        }

        /* Tooltip Styles - New! */
        #mapTooltip {
            position: absolute;
            display: none;
            background-color: rgba(0, 0, 0, 0.8); /* Black with 80% opacity */
            color: white;
            padding: 4px; /* 4px all side of text-size */
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none; /* Allows clicks to pass through to the map */
            z-index: 100; 
            white-space: nowrap;
            /* Small offset from cursor */
            transform: translate(10px, -10px); 
        }

        /* Buttons and List */
        .bulk-btn { 
            padding: 8px 12px; 
            background: #0073e6; 
            color: white; 
            border: none;
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.2s; 
            font-weight: 500;
        }
        .bulk-btn:hover { background: #005bb5; }
        
        /* Search Input Style */
        .search-input {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #C1C6CC;
        }
        
        /* NEIGHBORHOOD LIST SCROLL CONTAINER (Retained scroll for internal list) */
        .neighborhood-list { 
            max-height: 600px; 
            overflow-y: auto; 
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .neighborhood-item { 
            display: flex; 
            align-items: center; 
            padding: 6px 12px; 
            gap: 10px; 
            cursor: pointer;
            transition: background 0.2s;
        }
        .neighborhood-item:hover { background: #f9fafb; }
        .neighborhood-item.highlighted { 
            background: #e0f2fe; 
            border-left: 4px solid #0ea5e9;
        }
        .neighborhood-item.active-for-coloring {
            background: #fef3c7 !important;
            border-left: 4px solid #f59e0b !important;
        }
        .neighborhood-item input[type="checkbox"] { cursor: pointer; }
        .neighborhood-item label { flex: 1; font-size: 14px; color: #374151; }

        /* Color input styled as a chip */
        .color-input-chip {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: #374151;
        }

        .color-input-chip::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 50%;
        }

        .color-input-chip::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .color-input-chip::-moz-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .color-input-chip:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px #bfdbfe;
        }

        .color-input-chip.selected {
            border-width: 2px;
        }

        /* Map Styles */
        .map-svg { 
            width: 100%; 
            height: 100%; 
            display: block; 
        }
        
        .map-svg path.neighborhood { 
            cursor: pointer; 
            stroke: #374151; 
            stroke-width: 1.25; 
            fill: transparent;
            transition: all 0.2s; 
        }
        
        .map-svg path.neighborhood:hover { stroke-width: 2; }
        .map-svg path.neighborhood.selected { stroke-width: 2; }
        .map-svg path.neighborhood.hovered { fill: #fef3c7; }
        
        /* Export buttons */
        .export-btn { 
            padding: 8px 15px; 
            background: #0073e6; 
            color: white; 
            border: none;
            border-radius: 6px; 
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            cursor: pointer;
            width: 150px;
        }
        .export-btn:hover { background: #005bb5; }

        /* Utility classes replacing Tailwind */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .hidden { display: none; }
        .w-0 { width: 0; }
        .h-0 { height: 0; }
        .p-0 { padding: 0; }
        .border-none { border: none; }

        /* Responsive adjustments for mobile/tablet */
        @media (max-width: 1024px) {
            .container { 
                flex-direction: column; 
                gap: 16px;
                min-height: auto; 
            }
            .sidebar { 
                width: 100%; 
            }
            .map-wrapper {
                min-width: 100%;
                flex: 1; 
            }
            .neighborhood-list {
                max-height: 600px;
            }
        }

    </style>
</head>
<body>
    <h1>Manhattan Neighborhood Map Tool</h1>
    <div class="container">
        <!-- The Sidebar (Controls) -->
        <div class="sidebar">
            <div class="section">
                <h2>Neighborhoods</h2>
                
                <div class="bulk-actions flex space-x-2 mb-3">
                    <button class="bulk-btn" onclick="selectAll()">Select All</button>
                    <button class="bulk-btn" onclick="deselectAll()">Deselect All</button>
                </div>

                <!-- SEARCH INPUT -->
                <input type="text" id="neighborhoodSearch" class="search-input" placeholder="Filter neighborhoods..." oninput="filterNeighborhoods()">
                
                <!-- The neighborhood list will be populated here -->
                <div class="neighborhood-list" id="neighborhoodList"></div>
            </div>
            
            <div class="section">
                <h2>Color Palette</h2>
                <div class="color-palette" id="colorPalette">
                    <!-- Preset colors will be added here by JavaScript -->
                </div>
            </div>
            
            <div class="section">
                <h2>Export</h2>
                <div class="export-buttons flex flex-col space-y-2">
                    <button class="export-btn" onclick="exportMap('png')">Download PNG</button>
                    <button class="export-btn" onclick="exportMap('jpeg')">Download JPEG</button>
                    <button class="export-btn" onclick="exportMap('svg')">Download SVG</button>
                </div>
            </div>
        </div>
        
        <!-- The Map Preview -->
        <div class="map-wrapper">
            <h2 class="map-preview-title">Map Preview</h2>
            <div class="map-container">
                <!-- Hover Tooltip - NEW -->
                <div id="mapTooltip" class="hidden"></div> 
                <!-- Main SVG map area -->
                <svg class="map-svg" id="mapSvg" viewBox="0 0 600 1080"></svg>
            </div>
        </div>
    </div>

    <script>
        // Preset color palette
        const presetColors = [
            { name: 'Green', hex: '#157F60' },
            { name: 'Apple', hex: '#7EA75C' },
            { name: 'Olive', hex: '#A9AE4A' },
            { name: 'Yellow', hex: '#E1C321' },
            { name: 'Orange', hex: '#E5AA1A' },
            { name: 'Sunrise', hex: '#E39662' },
            { name: 'Peach', hex: '#DB8070' },
            { name: 'Coral', hex: '#C06259' },
            { name: 'Rosewood', hex: '#A85148' }
        ];

        // Data containing neighborhood names and SVG path definitions
        const paths = {"Inwood":"M263.8,61.6v-.8s.9,25.1.9,25.1l-6.7,20,2.8,11-4.7,1.3,2.5,18.7-10.8-13.8-33.3-22.6-8.6,1.4s-10.7-2.3-14.9,2.8l-1.1-8-2.8-.4-6.2-22.6.8-23.4s13.6-12.9,19.9-13c6.3,0,7.7,12.4,7.7,12.4l9.3,3.9,2.8-4.3-8.3-7.2,13.1-.6,25.1-6.2,6,2.6s3.7,18.1,5.9,21.6c0,.1.6,1.2.6,1.3","Fort_George":"M216.7,103.3l30.7,21,11.1,14.5.8,50.6-33.4-.7-9.3-67.3-4.3-9.4s0-6,4.4-8.7h0Z","Hudson_Heights":"M191.4,220.3s-7.5-10.5-6.5-12c1-1.5,5.6-11.1,5.6-11.1l3.1-45.8-1.4-44.4s1.6-7.4,13.7-3l8.3-1.8c.4,0,.8.4.5.8-1.6,2-4.6,6.2-3.3,9.3,1.7,4.1.6,2.4,4.2,9.5l9.2,68-2,10.2,5.5,20.4h-36.9Z","Washington_Heights":"M213.6,287.5h72.8s-23.8-33.5-20.8-43c.2-.7.3-1.5.2-2.3l-6.6-51.4-33.4-1s-1.4,7.7-1.7,9.4c-.3,1.7,5.5,22.1,5.5,22.1h-37.5s10.8,12.2,10.8,12.2l10.7,54h0Z","Upper_Manhattan":"M218.1,364.1s4.5-44.8-3.6-74.8h47.2s1.8,0,2.3,2.1.7,35.3.7,35.3l2.3,14.5v22.6l-48.9.3h0Z","Harlem":"M268.7,402h58.5l.4-42.6s-20.6-47.9-41.2-70.3h-21.4c0,0,.8,37.9.8,37.9l2.7,13.6.4,23.2s3.3,33.7-.7,33.3l.6,5h0Z","Manhattanville":"M216,387.4s2.1-22.1,2.2-22.1c1,0,48.6-.4,48.6-.4,0,0,3.7,16.7,0,32.1l-.2,5.7h-6.6c0-.1,0,7.1,0,7.1h-11.5v-7.9h-13c0,0,0-8.1,0-8.1h-8.7s-1.2-7.6-10.7-6.4h0Z","Morningside_Heights":"M217.4,459.6h42.2c0,0-6.4-21.3-4.5-23.8,0,0,2.1-14.6-1.3-21.2l-.3-3.8h-6v-7.9s-12.9,0-12.9,0v-8.1s-8.5,0-8.5,0c0,0-1.7-4.9-3.9-5.1-2.2-.2-.5-2.2-6.1-1.3l1.4,71.2h0Z","Central_Harlem":"M254.7,410.8h6.4s0-7.1,0-7.1h67c0,.1,0,56.2,0,56.2l-67.1-.5s-5.2-16.8-4.8-21.5c.5-4.7,1-15.1.2-18.4-.9-3.5-1.4-5.5-1.4-5.5l-.2-3.2h0Z","East_Harlem":"M314.1,513.5v-52.6c0,0,15.4,0,15.4,0v-97.2s4.5,12.4,11.5,15.4,29.5,14.1,39.2,30c6,9.8,7.7,16.7,8.2,20.6.2,1.8-.2,3.6-1.2,5.1-3.1,4.5-9.6,18.9-10.5,29.1-1,12.2,4.1,22.7-.3,32.1-4.4,9.4-4.2,17.4-4.2,17.4h-58.2Z","Northern_UWS":"M273,551.7h-54.9l-.3-91.1h55.2v91.1h0Z","Central_UWS":"M273,606.2h-54.9v-53.2h54.9c0,0,0,53.2,0,53.2Z","Lincoln_Square":"M273,607.4h-51.7c0,0-.1,48-.1,48h51.6c0-.1.2-48,.2-48h0Z","Carnegie_Hill":"M314,551.6l.2-36.6h30v36.6h-30.2,0Z","Yorkville":"M345.2,515h27.4s2.9,9.9,12.2,18.3c9.6,8.6,9.3,10,3.4,45.9h-42.8c0,0,0-64.2,0-64.2h0Z","Prime_UES":"M314.1,646.7v8.7h30.2v-102.8h-30.2v96","Lenox_Hill":"M345.4,580.3h42.8s1.9,32.6-8.6,74.8h-34.1v-74.8q0,0,0,0Z","Hells_Kitchen":"M272.7,656.3l-51.7.2v7.8l3.9,8,.5,22.3-1.7,3.7-.4,12-2.6,10.3v30.4c0,0,52,.2,52,.2v-94.7s0,0,0,0Z","Billionaires_Row":"M273.8,656.2h39.6v8.1h-39.6v-8.1Z","Midtown_West":"M273.8,665.5h39.6v85.5h-39.6v-85.5Z","Midtown_East":"M314.2,656.3h30v64.6h-30.3v-64.6Z","Midtown_East_East_of_Thirds":"M345,656.2h19.1l.7,64.7h-19.4l-.3-64.7h0Z","Sutton_Beekman":"M365.2,656.2h14.4s1.1,16.5-3.5,41.1h-10.5l-.4-41.1Z","Murray_Hill":"M373.2,722h-58.6v29.2h57.9l.7-29.2Z","West_Chelsea":"M220.6,751.9h39.3c0,0,.3,73.5.3,73.5h-15.2c0,0-11.2-27.5-11.2-27.5h-6.6l-7.1-28.4.5-17.6h0Z","Chelsea_Flatiron":"M261,752l37.9.2v29.4h29.3v44c0,0-67,0-67,0l-.2-73.6Z","NoMad":"M328.8,780.6h-28.6l-.2-28.4h14.5c0,0,13.8,0,13.8,0l.2,28.4","Kips_Bay":"M329.4,752.4h43.5l8.2,26.3v9.2h-51.3l-.4-35.5h0Z","Gramercy":"M413.5,825.7h-84.3l.2-36.7h52l15.7,20s9.8,2.1,12.2,5c0,0,8.2,13.2,4.3,11.8h0Z","West_Village":"M245.4,826.6l40.8-.2c-.8.1,1.4,49.6,6.3,55.9l-21.6,8.7-20.8-45.7-4.7-18.8Z","Greenwich_Village":"M287.1,826.6h56.9s-.5,34.1-.5,34.1l4.5,17.5s-15.3,1.7-18,2.2l-28.6-1.6-8,3.2s-5.3-7-6.4-55.3h0Z","East_Village":"M345,826.7h68.5s10.5,21.3,14.3,38.8c0,0-9.2,4.6-12.9,5.1l-65.7,7.7-4.7-17.7.4-33.9Z","SoHo":"M301.6,879.9l28.2,1.6,18.5-2.1,7.4,42.7h-10.8c0,0-10.9-3.3-10.9-3.3v1c-.1,0-25.1-6.5-25.1-6.5l-7.4-33.4h0Z","Hudson_Square":"M271.3,891.9l29.2-11.8,7.3,32.8-31.1-7.8-5.4-13.1","TriBeCa":"M278,906.7l55.6,14-1.6,16.8,2.2,5,2.5,2v6c-.1,0-11.8-.6-11.8-.6h-.6l-1,17.3-22.6-2.4-22.8-58.1h0Z","Lower_East_Side":"M366.2,964.3l-28.9-6.8,1-14-2.8-1.5-2.3-5.5,1.7-16.3,10,3h12.2l-7.4-43.7,66.2-8c.5,0,1.1-.2,1.7-.3l10.6-4.6s9.5,38.4,5.2,44.1l-67,53.6h0Z","Battery_Park_City":"M290.4,940.6l23.8,73.9-9.8,8.6s-8.6-14.3-17-38.6l7-2.4-2.3-6.3-7.2,1.9-10.4-30.6-.3-.4,16.2-6.1h0Z","Financial_District":"M315.8,1014.4l-4.3,4.4.8,5.6s9.5,9.7,16.2,8.5c0,0,15.6,3.4,29.2-21.5l8.2-30.9-4.5-5.7,4.5-9.3-30-7,.6-6.6-11-.5-1.1,17.5-23.3-2.5,14.7,48.3h0Z"};
        
        // List of neighborhood objects
        const neighborhoods = Object.keys(paths).map(k => ({ id: k, name: k.replace(/_/g, ' ') }));
        
        // Y-coordinate mapping for each neighborhood (approximate center positions in the map)
        // These correspond to the vertical position in the 1080px height map
        const neighborhoodPositions = {
            "Inwood": 80,
            "Fort_George": 120,
            "Hudson_Heights": 180,
            "Washington_Heights": 250,
            "Upper_Manhattan": 330,
            "Harlem": 370,
            "Manhattanville": 390,
            "Morningside_Heights": 430,
            "Central_Harlem": 430,
            "East_Harlem": 470,
            "Northern_UWS": 510,
            "Central_UWS": 570,
            "Lincoln_Square": 620,
            "Carnegie_Hill": 530,
            "Yorkville": 550,
            "Prime_UES": 600,
            "Lenox_Hill": 620,
            "Hells_Kitchen": 690,
            "Billionaires_Row": 665,
            "Midtown_West": 700,
            "Midtown_East": 695,
            "Midtown_East_East_of_Thirds": 690,
            "Sutton_Beekman": 680,
            "Murray_Hill": 735,
            "West_Chelsea": 780,
            "Chelsea_Flatiron": 785,
            "NoMad": 768,
            "Kips_Bay": 770,
            "Gramercy": 810,
            "West_Village": 850,
            "Greenwich_Village": 855,
            "East_Village": 850,
            "SoHo": 905,
            "Hudson_Square": 910,
            "TriBeCa": 935,
            "Lower_East_Side": 920,
            "Battery_Park_City": 990,
            "Financial_District": 1020
        };
        
        // Initial state
        const state = {
            selected: new Set(),    // Set of selected neighborhood IDs
            colors: {},             // Map of ID to assigned color
            currentDefaultColor: '#4ECDC4', // Default color (will be overridden by palette selection)
            activeColor: '#157F60', // Currently active color from palette (default to Green)
            activeId: null,         // The neighborhood ID that is currently interacting with the color picker
            activeNeighborhood: null, // The neighborhood currently being colored (NEW)
        };

        /**
         * Finds neighborhood name by ID.
         */
        function getNeighborhoodName(id) {
            const item = neighborhoods.find(n => n.id === id);
            return item ? item.name : id.replace(/_/g, ' ');
        }

        /**
         * Shows the tooltip on the map, positioned relative to the map container.
         */
        function showTooltip(id, event) {
            const tooltip = document.getElementById('mapTooltip');
            const mapContainer = document.querySelector('.map-container');
            // Get the bounding box of the map container to calculate relative position
            const rect = mapContainer.getBoundingClientRect();

            // Set text content
            tooltip.textContent = getNeighborhoodName(id);

            // Calculate position based on the mouse event, relative to the container's top-left corner
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Position the tooltip
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
            tooltip.style.display = 'block';
        }

        /**
         * Hides the tooltip.
         */
        function hideTooltip() {
            document.getElementById('mapTooltip').style.display = 'none';
        }

        /**
         * Initializes the application by rendering the list and the map.
         */
        function init() {
            renderColorPalette();
            renderNeighborhoodList(neighborhoods); // Render the full list initially
            renderMap();
            initSyncScrolling(); // Initialize synchronized scrolling
        }

        /**
         * Renders the color palette with preset colors and custom option
         */
        function renderColorPalette() {
            const paletteContainer = document.getElementById('colorPalette');
            if (!paletteContainer) return;

            let paletteHtml = '';

            // Add preset color swatches
            presetColors.forEach(color => {
                const isActive = state.activeColor === color.hex;
                paletteHtml += `
                    <div class="palette-swatch ${isActive ? 'active' : ''}" 
                         style="background-color: ${color.hex};"
                         title="${color.name}"
                         onclick="selectPaletteColor('${color.hex}')"
                         data-color="${color.hex}">
                    </div>
                `;
            });

            // Add custom color picker as a styled input (Safari-compatible)
            const isCustomActive = !presetColors.find(c => c.hex === state.activeColor);
            const customButtonTitle = state.activeNeighborhood 
                ? "Pick custom color" 
                : "Click a neighborhood first, then use custom color";
            
            const isDisabled = !state.activeNeighborhood;
            
            paletteHtml += `
                <label class="custom-color-btn-wrapper" title="${customButtonTitle}">
                    <input type="color" 
                           id="customColorPicker" 
                           class="custom-color-input"
                           onchange="handleCustomColorPick(this.value)"
                           value="${state.activeColor}"
                           ${isDisabled ? 'disabled' : ''}>
                    <div class="custom-color-btn ${isCustomActive ? 'active' : ''}" 
                         style="${isDisabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        +
                    </div>
                </label>
            `;

            paletteContainer.innerHTML = paletteHtml;
        }

        /**
         * Selects a color from the preset palette
         */
        function selectPaletteColor(color) {
            state.activeColor = color;
            state.currentDefaultColor = color;
            
            // If there's an active neighborhood, apply color to it
            if (state.activeNeighborhood) {
                state.colors[state.activeNeighborhood] = color;
                updateMapAndList();
            }
            
            renderColorPalette();
        }

        /**
         * Opens custom color picker for the active neighborhood
         * Note: Now handled directly by the visible color input element
         */
        function openCustomColorPicker() {
            // This function is no longer needed as the color input is directly clickable
            // Keeping it for backwards compatibility
        }

        /**
         * Handles custom color selection from native picker
         */
        function handleCustomColorPick(color) {
            state.activeColor = color;
            state.currentDefaultColor = color;
            
            // If there's an active neighborhood, apply color to it
            if (state.activeNeighborhood) {
                state.colors[state.activeNeighborhood] = color;
                updateMapAndList();
            }
            
            renderColorPalette();
        }

        /**
         * Initialize synchronized scrolling between neighborhood list and map
         */
        function initSyncScrolling() {
            const neighborhoodList = document.querySelector('.neighborhood-list');
            const mapContainer = document.querySelector('.map-container');
            
            let isListScrolling = false;
            let isMapScrolling = false;
            let listScrollTimeout;
            let mapScrollTimeout;
            
            // When neighborhood list scrolls, sync the map
            neighborhoodList.addEventListener('scroll', function() {
                if (isMapScrolling) {
                    isMapScrolling = false;
                    return;
                }
                
                isListScrolling = true;
                
                // Clear previous timeout
                clearTimeout(listScrollTimeout);
                
                // Get the scroll percentage of the list
                const listScrollPercentage = neighborhoodList.scrollTop / 
                    (neighborhoodList.scrollHeight - neighborhoodList.clientHeight);
                
                // Calculate corresponding map scroll position
                const mapScrollHeight = mapContainer.scrollHeight - mapContainer.clientHeight;
                const targetMapScroll = listScrollPercentage * mapScrollHeight;
                
                // Scroll the map
                mapContainer.scrollTop = targetMapScroll;
                
                // Highlight visible neighborhoods in the list
                highlightVisibleNeighborhoods();
                
                // Reset flag after a delay
                listScrollTimeout = setTimeout(() => {
                    isListScrolling = false;
                }, 100);
            });
            
            // When map scrolls, sync the list
            mapContainer.addEventListener('scroll', function() {
                if (isListScrolling) {
                    isListScrolling = false;
                    return;
                }
                
                isMapScrolling = true;
                
                // Clear previous timeout
                clearTimeout(mapScrollTimeout);
                
                // Get the scroll percentage of the map
                const mapScrollPercentage = mapContainer.scrollTop / 
                    (mapContainer.scrollHeight - mapContainer.clientHeight);
                
                // Calculate corresponding list scroll position
                const listScrollHeight = neighborhoodList.scrollHeight - neighborhoodList.clientHeight;
                const targetListScroll = mapScrollPercentage * listScrollHeight;
                
                // Scroll the list
                neighborhoodList.scrollTop = targetListScroll;
                
                // Highlight visible neighborhoods
                highlightVisibleNeighborhoods();
                
                // Reset flag after a delay
                mapScrollTimeout = setTimeout(() => {
                    isMapScrolling = false;
                }, 100);
            });
        }
        
        /**
         * Highlights neighborhoods that are currently visible in the map viewport
         */
        function highlightVisibleNeighborhoods() {
            const mapContainer = document.querySelector('.map-container');
            const svgElement = document.getElementById('mapSvg');
            const svgHeight = svgElement.getBoundingClientRect().height;
            const scaleFactor = svgHeight / 1080;
            
            // Calculate visible range in map coordinates
            const scrollTop = mapContainer.scrollTop;
            const containerHeight = mapContainer.clientHeight;
            const visibleTop = scrollTop / scaleFactor;
            const visibleBottom = (scrollTop + containerHeight) / scaleFactor;
            const visibleCenter = (visibleTop + visibleBottom) / 2;
            
            // Find neighborhoods in visible area and highlight the closest one to center
            let closestId = null;
            let closestDistance = Infinity;
            
            Object.entries(neighborhoodPositions).forEach(([id, yPos]) => {
                const distance = Math.abs(yPos - visibleCenter);
                if (yPos >= visibleTop && yPos <= visibleBottom) {
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestId = id;
                    }
                }
            });
            
            // Apply subtle highlight to the centered neighborhood
            neighborhoods.forEach(item => {
                const listItem = document.getElementById(`item-${item.id}`);
                const mapPath = document.getElementById(`p-${item.id}`);
                
                if (item.id === closestId) {
                    if (listItem && !state.selected.has(item.id)) {
                        listItem.style.background = '#f0f9ff';
                    }
                } else {
                    if (listItem && !listItem.classList.contains('highlighted')) {
                        listItem.style.background = '';
                    }
                }
            });
        }

        /**
         * Filters the neighborhood list based on the search input value.
         */
        function filterNeighborhoods() {
            const searchTerm = document.getElementById('neighborhoodSearch').value.toLowerCase();
            
            const filteredList = neighborhoods.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );

            // Re-render the list with only the filtered items
            renderNeighborhoodList(filteredList);
        }

        /**
         * Renders the list of neighborhoods in the sidebar.
         * @param {Array} listToRender - The list of neighborhood objects to display.
         */
        function renderNeighborhoodList(listToRender) {
            const listElement = document.getElementById('neighborhoodList');
            if (!listElement) return;

            const listHtml = listToRender.map(item => `
                <div class="neighborhood-item" id="item-${item.id}" 
                     data-id="${item.id}"
                     onmouseenter="listHighlight('${item.id}', true)" 
                     onmouseleave="listHighlight('${item.id}', false)">
                    
                    <input type="checkbox" id="cb-${item.id}" 
                           ${state.selected.has(item.id) ? 'checked' : ''}
                           onchange="toggleNeighborhoodSelection('${item.id}', true)">
                    
                    <label for="cb-${item.id}">${item.name}</label>
                    
                    <!-- Color input styled as chip -->
                    <input type="color" 
                           id="color-input-${item.id}" 
                           class="color-input-chip ${state.selected.has(item.id) ? 'selected' : ''}"
                           onchange="handleNativeColorChange('${item.id}', this.value)"
                           onclick="handleColorInputClick(event, '${item.id}')"
                           value="${state.colors[item.id] || '#374151'}">
                </div>
            `).join('');
            listElement.innerHTML = listHtml;
        }

        /**
         * Renders the SVG map structure and sets up hover/click handlers.
         */
        function renderMap() {
            const svgElement = document.getElementById('mapSvg');
            // Add base map as background layer - using GitHub raw URL with .svg extension
            svgElement.innerHTML = '<image href="https://raw.githubusercontent.com/curiousmino/Manhattan_map/refs/heads/main/Manhattan%20Map.svg" x="0" y="0" width="600" height="1080"/>'; 
            
            Object.entries(paths).forEach(([id, d]) => {
                const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                pathElement.setAttribute('d', d);
                pathElement.setAttribute('id', `p-${id}`);
                pathElement.setAttribute('class', 'neighborhood');
                pathElement.setAttribute('data-id', id);
                pathElement.onclick = () => mapClick(id);

                // New Handlers for Tooltip and List Highlighting
                pathElement.onmousemove = (e) => showTooltip(id, e); 
                pathElement.onmouseenter = (e) => { 
                    listHighlight(id, true); 
                    showTooltip(id, e); 
                };
                pathElement.onmouseleave = () => { 
                    listHighlight(id, false); 
                    hideTooltip(); 
                };

                svgElement.appendChild(pathElement);
            });
        }

        /**
         * Map-First Workflow: Handles click events on a neighborhood path.
         */
        function mapClick(id) {
            // Check if selected, if not, select it first
            if (!state.selected.has(id)) {
                toggleNeighborhoodSelection(id, false);
            }
            
            // Highlight the list item (for visual feedback)
            listHighlight(id, true);

            // Set active ID and trigger the color picker
            state.activeId = id;
            const colorInput = document.getElementById(`color-input-${id}`);
            if (colorInput) {
                colorInput.click();
            }
        }

        /**
         * Opens the native color picker for a neighborhood.
         */
        function handleColorInputClick(event, id) {
            event.stopPropagation();
            event.preventDefault(); // Prevent color picker from opening immediately
            
            // Select if not already selected
            if (!state.selected.has(id)) {
                toggleNeighborhoodSelection(id, false);
            }

            // Set this as the active neighborhood for coloring
            state.activeNeighborhood = id;
            state.activeId = id;
            
            // Highlight the active neighborhood in the list
            highlightActiveNeighborhood(id);
            
            // Now user can click palette colors to apply to this neighborhood
            // Or click the custom color button to open the native picker
        }


        /**
         * Highlights the active neighborhood in the list for visual feedback
         */
        function highlightActiveNeighborhood(id) {
            // Remove previous active-for-coloring highlights
            document.querySelectorAll('.neighborhood-item').forEach(item => {
                item.classList.remove('active-for-coloring');
            });
            
            // Add active-for-coloring highlight to current neighborhood
            const item = document.getElementById(`item-${id}`);
            if (item) {
                item.classList.add('active-for-coloring');
            }
        }

        /**
         * Handles color change from the native color input.
         */
        function handleNativeColorChange(id, color) {
            // Apply the custom color to the neighborhood
            state.colors[id] = color;
            state.activeColor = color;
            updateMapAndList();
            renderColorPalette();
        }

        /**
         * Toggles the selection state of a neighborhood.
         */
        function toggleNeighborhoodSelection(id, fromList) {
            const checkbox = document.getElementById(`cb-${id}`);
            
            // Logic to determine the new checked state:
            // - If fromList (checkbox click), use the new checked state.
            // - If not fromList (map click or color indicator click), force it to be checked/selected.
            const newCheckedState = fromList ? checkbox.checked : true;
            
            if (newCheckedState) {
                state.selected.add(id);
                // DON'T auto-assign color - let chips stay grey until user picks a color
            } else {
                state.selected.delete(id);
                // Remove color when deselecting - will revert to gray default
                delete state.colors[id];
            }
            
            // Ensure the checkbox reflects the selection state (important for filtered lists)
            if (checkbox) checkbox.checked = newCheckedState;
            
            updateMapAndList();
            listHighlight(id, newCheckedState);
            // After selection change, ensure the filter remains active on the list
            filterNeighborhoods();
        }

        /**
         * Highlights the corresponding list item and map path (on hover).
         */
        function listHighlight(id, shouldHighlight) {
            const listItem = document.getElementById(`item-${id}`);
            const mapPath = document.getElementById(`p-${id}`);
            
            // List Item Highlight
            if (listItem) {
                if (shouldHighlight) {
                    listItem.classList.add('highlighted');
                } else {
                    // Only remove if it's not the active item (prevents removing highlight 
                    // if the color picker is open or map is selected)
                    if (state.activeId !== id) {
                         listItem.classList.remove('highlighted');
                    }
                }
            }

            // Map Path Highlight (Hover Effect)
            if (mapPath) {
                 if (shouldHighlight) {
                    mapPath.classList.add('hovered');
                } else {
                    mapPath.classList.remove('hovered');
                }
            }
        }


        /**
         * Updates the map and list visual state based on current selection/colors.
         */
        function updateMapAndList() {
            neighborhoods.forEach(item => {
                const mapPath = document.getElementById(`p-${item.id}`);
                const colorInput = document.getElementById(`color-input-${item.id}`);
                const checkbox = document.getElementById(`cb-${item.id}`);

                if (state.selected.has(item.id)) {
                    // Neighborhood is selected
                    
                    if (state.colors[item.id]) {
                        // Has a color assigned
                        const color = state.colors[item.id];
                        mapPath.style.stroke = color;
                        mapPath.style.fill = 'transparent'; 
                        mapPath.classList.add('selected');
                        if (colorInput) {
                            colorInput.value = color;
                        }
                    } else {
                        // Selected but no color assigned yet - stay grey
                        mapPath.style.stroke = '#374151';
                        mapPath.style.fill = 'transparent';
                        mapPath.classList.add('selected');
                        if (colorInput) {
                            colorInput.value = '#374151';
                        }
                    }

                    // List Checkbox Update
                    if (checkbox) checkbox.checked = true;

                } else {
                    // Deselected state
                    mapPath.style.stroke = '#374151'; // Default stroke color
                    mapPath.style.fill = 'transparent'; // Transparent fill to show base map
                    mapPath.classList.remove('selected');

                    // List Checkbox Update
                    if (checkbox) checkbox.checked = false;

                    // Color Input Update
                    if (colorInput) {
                        colorInput.value = '#374151'; // Reset to default dark gray
                        colorInput.classList.remove('selected');
                    }
                }
            });
            // Re-render the filtered list to ensure checkmarks and colors are correct
            filterNeighborhoods(); 
        }

        /**
         * Selects all neighborhoods and sets the active color from palette.
         */
        function selectAll() {
            neighborhoods.forEach(item => {
                state.selected.add(item.id);
                state.colors[item.id] = state.colors[item.id] || state.activeColor;
            });
            updateMapAndList();
        }

        /**
         * Deselects all neighborhoods and clears all colors.
         */
        function deselectAll() {
            state.selected.clear();
            state.colors = {}; // Clear all colors - neighborhoods will revert to gray
            updateMapAndList();
        }

        /**
         * Export functions.
         */
        /**
         * Exports the map as PNG, JPEG, or SVG with embedded base map.
         */
        async function exportMap(fmt) {
            const svgElement = document.getElementById('mapSvg');
            // Remove hover effects before cloning for export
            const tempSvg = svgElement.cloneNode(true);
            tempSvg.querySelectorAll('.hovered').forEach(el => el.classList.remove('hovered'));
            
            // Remove tooltip from export
            const tooltip = tempSvg.querySelector('#mapTooltip');
            if (tooltip) tooltip.remove();

            // For reliable exports, we need to embed the base map image as data URL
            const baseImage = tempSvg.querySelector('image');
            if (baseImage && fmt !== 'svg') {
                // For PNG/JPEG, fetch the base map and convert to data URL
                try {
                    const response = await fetch('https://raw.githubusercontent.com/curiousmino/Manhattan_map/refs/heads/main/Manhattan%20Map.svg');
                    const svgText = await response.text();
                    const dataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgText)));
                    baseImage.setAttribute('href', dataUrl);
                } catch (error) {
                    console.error('Failed to fetch base map:', error);
                    alert('Could not load base map for export. Please check your internet connection and try again.');
                    return;
                }
            } else if (baseImage) {
                // For SVG export, keep the GitHub URL
                baseImage.setAttribute('href', 'https://raw.githubusercontent.com/curiousmino/Manhattan_map/refs/heads/main/Manhattan%20Map.svg');
            }

            // Set the fill of non-selected paths for a clean export background
            tempSvg.querySelectorAll('path.neighborhood').forEach(path => {
                const id = path.getAttribute('data-id');
                if (!state.selected.has(id)) {
                    path.style.fill = 'transparent'; 
                }
            });

            if (fmt === 'svg') {
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(tempSvg);
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                downloadFile(blob, 'manhattan-map.svg');
            } else {
                // PNG/JPEG export via Canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const svgData = new XMLSerializer().serializeToString(tempSvg);
                const image = new Image();

                image.onload = () => {
                    // Use a higher resolution for better quality export
                    canvas.width = 1800; 
                    canvas.height = 3240;
                    
                    // Set background based on format
                    if (fmt === 'jpeg') {
                        // White background for JPEG
                        context.fillStyle = 'white';
                        context.fillRect(0, 0, canvas.width, canvas.height);
                    }
                    // PNG keeps transparent background (no fill needed)
                    
                    context.drawImage(image, 0, 0, canvas.width, canvas.height);
                    
                    // Convert to blob and download
                    const mimeType = `image/${fmt}`;
                    const quality = fmt === 'jpeg' ? 0.95 : 1.0;
                    canvas.toBlob(blob => downloadFile(blob, `manhattan-map.${fmt}`), mimeType, quality);
                };
                
                image.onerror = () => {
                    console.error('Export failed - could not load SVG image');
                    alert('Export failed. The base map image may not have loaded. Please try again.');
                };
                
                // Encode the SVG data
                image.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
            }
        }

        /**
         * Utility function to trigger file download.
         */
        function downloadFile(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = fileName;
            document.body.appendChild(anchor); // Required for Firefox
            anchor.click();
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
        }

        // Initialize the app on load
        init();
        // Call filter initially to ensure proper rendering based on state
        filterNeighborhoods(); 
    </script>
</body>
</html>
